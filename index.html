<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雨歌作品集</title>
    <link rel="icon" type="image/png" href="https://rainchord.com/wp-content/uploads/2019/06/favicon-o.png">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet">
<style>
    @font-face {
        font-family: 'JFOpenHuninn';
        src: url('https://ymdd-image-tw.s3.ap-east-2.amazonaws.com/font/jf-openhuninn-2.1.ttf') format('truetype');
        font-weight: normal; font-style: normal;
    }
    :root {
        --primary-color: #1abc9c; --secondary-color: #FFECB3; --secondary-color-darker: #FFD54F;
        --bg-color: #ffffff; --card-bg: #ffffff; --text-color: #4a6572;
        --shadow: 0 10px 30px rgba(26, 188, 156, 0.15); --border-radius: 25px; 
    }
    body {
        font-family: 'JFOpenHuninn', '微軟正黑體', sans-serif; margin: 0; padding: 0; color: var(--text-color);
        min-height: 100vh; display: flex; flex-direction: column; background-color: #f0f8f7; 
        background-image: url('https://rainchord.s3.ap-east-2.amazonaws.com/bg-s.png'); 
        background-size: cover; background-position: center; background-attachment: fixed; position: relative; 
    }
    body::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7); z-index: -1; }
    .container { max-width: 1100px; width: 90%; margin: 0 auto; padding: 15px 0; flex-grow: 1; }
    header { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); position: sticky; top: 0; z-index: 100; padding: 5px 0 10px 0; }
    h1 { color: var(--primary-color); text-align: center; margin-top: 0; margin-bottom: 15px; padding-top: 10px; font-size: 2.6rem; font-weight: 700; }
    .category-nav { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; padding: 0 10px; }
    .category-btn { background: #ecf0f1; color: var(--text-color); border: none; padding: 10px 22px; border-radius: 30px; cursor: pointer; transition: all 0.2s ease; font-weight: 600; flex-shrink: 0; }
    @media (max-width: 768px) {
        .category-nav.is-scrollable { justify-content: flex-start; flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; padding-bottom: 5px; }
        .category-nav.is-scrollable::-webkit-scrollbar { display: none; }
    }
    .category-btn:hover { background-color: var(--secondary-color); transform: scale(1.05); }
    .category-btn.active { background-color: var(--primary-color); color: white; box-shadow: 0 4px 10px rgba(26, 188, 156, 0.5); }
    #projects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; }
    .project-card { background: var(--card-bg); border-radius: var(--border-radius); padding: 30px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); cursor: pointer; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s ease; display: flex; flex-direction: column; justify-content: space-between; min-height: 150px; position: relative; }
    .project-card:hover { transform: translateY(-10px); box-shadow: var(--shadow); }
    .project-card h3 { color: var(--primary-color); margin-top: 0; margin-bottom: 15px; font-size: 1.4rem; }
    .project-card p { font-size: 1rem; color: #7f8c8d; margin: 0; }
    .modal { position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.4); display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
    .modal.open { display: flex; opacity: 1; }
    .modal-content { background-color: var(--card-bg); margin: 10% auto; padding: 35px; border-radius: var(--border-radius); width: 90%; max-width: 650px; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2); position: relative; }
    @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal.open .modal-content { animation: slideIn 0.3s ease-out; }
    .close-btn { color: #aaa; float: right; font-size: 30px; font-weight: bold; cursor: pointer; line-height: 1; }
    .modal-body h2 { color: var(--primary-color); margin-top: 0; margin-bottom: 15px; font-size: 2rem; }
    .modal-body p { color: var(--text-color); line-height: 1.6; font-size: 1.05rem; margin-bottom: 25px; white-space: pre-wrap; }
    .link-container { display: flex; flex-wrap: wrap; gap: 15px; border-top: 1px solid #f0f0f0; padding-top: 20px; }
    .link-container a { background-color: var(--secondary-color); color: var(--text-color); padding: 12px 22px; border-radius: 10px; text-decoration: none; font-weight: bold; transition: all 0.1s ease; display: inline-flex; align-items: center; border: 2px solid var(--secondary-color-darker); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
    #status-message { text-align: center; padding: 50px; font-size: 1.2rem; color: #666; background: white; border: 1px solid #eee; border-radius: 10px; margin: 50px auto; }
</style>
</head>
<body>

    <header>
        <div class="container">
            <h1 id="page-title">雨歌作品集</h1>
            <div id="category-nav" class="category-nav"></div>
        </div>
    </header>

    <div class="container">
        <div id="status-message">載入中，請稍候...</div>
        <div id="projects-grid"></div>
    </div>

    <div id="projectModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div class="modal-body">
                <h2 id="modal-title"></h2>
                <p id="modal-description"></p>
                <div id="modal-links" class="link-container"></div>
            </div>
        </div>
    </div>
    
    <div style="text-align:center; padding: 20px 0;">
        <p>Made in Love by Ivy</p>
        <button onclick="manualRefresh()" style="background:none; border:none; color:#ccc; font-size:11px; cursor:pointer; text-decoration:underline;">強制重載資料庫</button>
    </div>

<script>
// 請更換為您部署後的 GAS URL
const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbzlG1a8jbkrAWtkapWrfSMjLwzsJMjm_A0QXuC2zJvEBTKBN9ij1YhxQ82Xg79jSt0MRw/exec'; 

const projectsGrid = document.getElementById('projects-grid');
const categoryNav = document.getElementById('category-nav');
const statusMessage = document.getElementById('status-message');
const modal = document.getElementById('projectModal');
const closeBtn = document.querySelector('.close-btn');

let allProjects = [];
let currentCategory = 'All';

// 初始化參數
const urlParams = new URLSearchParams(window.location.search);
const userKey = urlParams.get('key');

// 快取名稱 (包含 Key，確保帶 Key 與不帶 Key 的快取分開)
const CACHE_KEY = `projects_cache_${userKey || 'public'}`;

closeBtn.onclick = () => modal.classList.remove('open');
window.onclick = (e) => { if (e.target == modal) modal.classList.remove('open'); };

/**
 * 1. 抓取資料 (比對更新機制)
 */
async function fetchProjects() {
    const cachedData = localStorage.getItem(CACHE_KEY);
    const now = Date.now();

    // 優先從本機快取渲染
    if (cachedData) {
        console.log("從本機快取快速加載...");
        allProjects = JSON.parse(cachedData);
        processData(allProjects);
    } else {
        statusMessage.style.display = 'block';
    }

    // 背景靜默抓取最新資料
    try {
        // 加入 t=now 避免瀏覽器緩存 API 請求
        const finalUrl = userKey ? `${GAS_API_URL}?key=${userKey}&t=${now}` : `${GAS_API_URL}?t=${now}`;
        const response = await fetch(finalUrl);
        if (!response.ok) throw new Error(`HTTP 錯誤`);
        const result = await response.json();
        
        if (result.data) {
            const newDataString = JSON.stringify(result.data);
            
            // 重要：比對新抓到的資料跟快取是否一致
            if (newDataString !== cachedData) {
                console.log("偵測到資料更新，自動同步畫面...");
                allProjects = result.data.filter(p => p.Title && p.Category);
                localStorage.setItem(CACHE_KEY, newDataString);
                processData(allProjects);
            } else {
                console.log("資料無變動，維持快取內容。");
            }
        }
    } catch (error) {
        console.error('背景同步失敗:', error);
        if (!cachedData) {
            statusMessage.textContent = `載入失敗：${error.message}`;
        }
    }
}

/**
 * 2. 處理資料渲染
 */
function processData(projects) {
    statusMessage.style.display = 'none';
    renderCategories(projects);
    filterAndRenderProjects(currentCategory);
    checkOverflowAndAdjust(); 
}

/**
 * 3. 渲染分類按鈕
 */
function renderCategories(projects) {
    const categories = new Set(['All']);
    projects.forEach(p => {
        if (p.Category) {
            p.Category.toString().split(',').forEach(cat => categories.add(cat.trim()));
        }
    });

    // 如果目前選擇的分類在新資料中不存在，則跳回 All
    if (!categories.has(currentCategory)) currentCategory = 'All';

    categoryNav.innerHTML = '';
    categories.forEach(category => {
        const btn = document.createElement('button');
        btn.className = 'category-btn' + (category === currentCategory ? ' active' : '');
        btn.textContent = category;
        btn.onclick = () => {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentCategory = category;
            filterAndRenderProjects(category);
        };
        categoryNav.appendChild(btn);
    });
}

/**
 * 4. 渲染作品卡片
 */
function filterAndRenderProjects(category) {
    const filtered = allProjects.filter(p => {
        if (category === 'All') return true;
        const cats = p.Category.toString().split(',').map(c => c.trim());
        return cats.includes(category);
    });

    projectsGrid.innerHTML = filtered.length ? '' : `<div style="text-align: center; grid-column: 1 / -1; padding: 50px;">此分類下目前沒有作品。</div>`;

    filtered.forEach(project => {
        const card = document.createElement('div');
        card.className = 'project-card';
        card.onclick = () => showProjectModal(project);
        card.innerHTML = `
            <h3><i class="ri-rocket-line"></i> ${project.Title}</h3>
            <p>${project.Description ? project.Description.substring(0, 80) + (project.Description.length > 80 ? '...' : '') : '無說明'}</p>
        `;
        projectsGrid.appendChild(card);
    });
}

/**
 * 5. 顯示彈窗
 */
function showProjectModal(project) {
    document.getElementById('modal-title').textContent = project.Title;
    document.getElementById('modal-description').textContent = project.Description || '無詳細說明。';
    const container = document.getElementById('modal-links');
    container.innerHTML = '';

    const iconMap = { 'demo': 'ri-eye-line', 'github': 'ri-github-fill', '文件': 'ri-file-text-line' };
    for (let i = 1; i <= 5; i++) {
        const url = project[`Link${i}`], text = project[`Link${i}_Text`];
        if (url && text) {
            const icon = Object.keys(iconMap).find(k => text.toLowerCase().includes(k)) || 'ri-links-line';
            const a = document.createElement('a');
            a.href = url; a.target = '_blank';
            a.innerHTML = `<i class="${icon}"></i> ${text}`;
            container.appendChild(a);
        }
    }
    if (!container.children.length) container.innerHTML = `<p style="color: #999;">目前沒有連結。</p>`;
    modal.classList.add('open');
}

/**
 * 6. 手動強制更新 (隱藏小按鈕用)
 */
function manualRefresh() {
    if(confirm("即將清空本機快取並重新抓取資料庫，確定嗎？")) {
        localStorage.clear();
        location.reload();
    }
}

/**
 * 7. 溢出檢查與防抖
 */
function checkOverflowAndAdjust() {
    const nav = document.querySelector('.category-nav');
    if (!nav || window.innerWidth > 768) {
        if(nav) nav.classList.remove('is-scrollable');
        return;
    }
    nav.style.flexWrap = 'nowrap';
    const isOver = nav.scrollWidth > nav.clientWidth;
    nav.style.flexWrap = '';
    nav.classList.toggle('is-scrollable', isOver);
}

function debounce(func, delay) {
    let timeout;
    return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
    };
}

window.addEventListener('resize', debounce(checkOverflowAndAdjust, 100));
document.addEventListener('DOMContentLoaded', fetchProjects);
</script>
</body>
</html>

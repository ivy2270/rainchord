<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é›²ç«¯è¨˜äº‹æœ¬</title>
  <link rel="icon" type="image/svg+xml" href="note-notepad-svgrepo-com.svg">
  <style>
    /* 1. å¼•å…¥å­—é«” */
    @font-face {
        font-family: 'JFOpenHuninn';
        src: url('https://ymdd-image-tw.s3.ap-east-2.amazonaws.com/font/jf-openhuninn-2.1.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
    }

    :root {
      --bg-color: #f0f4f7;
      --card-bg-color: #ffffff;
      --primary-text-color: #212121;
      --secondary-text-color: #616161;
      --border-color: #e0e0e0;
      --accent-color: #00668c;
      --danger-color: #b86a6a;
      --edit-color: #8c9e5e;
      --copy-color: #b8a47e;
    }

    body {
      font-family: 'JFOpenHuninn', -apple-system, sans-serif;
      background-color: var(--bg-color);
      color: var(--primary-text-color);
      margin: 0;
      padding: 24px;
      display: flex;
      justify-content: center;
    }

    #app-container { width: 100%; max-width: 960px; }
    h1 { text-align: center; font-weight: 700; margin-bottom: 32px; }

    /* è¼¸å…¥å€åŸŸ */
    .input-area {
      background: var(--card-bg-color);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 32px;
      border: 1px solid var(--border-color);
    }
    #note-input {
      width: 100%; min-height: 90px; padding: 12px; box-sizing: border-box;
      border: 1px solid var(--border-color); border-radius: 8px;
      font-size: 16px; line-height: 1.7; resize: vertical;
      font-family: inherit;
    }
    #add-btn {
      display: block; width: 100%; padding: 14px; margin-top: 16px;
      font-size: 16px; font-weight: 500; color: #fff;
      background-color: var(--accent-color); border: none;
      border-radius: 8px; cursor: pointer; font-family: inherit;
      transition: background-color 0.3s;
    }
    #add-btn:hover { background-color: #005a78; }

    /* æœå°‹ */
    #search-input {
      width: 100%; padding: 12px; box-sizing: border-box;
      border: 1px solid var(--border-color); border-radius: 8px;
      margin-bottom: 24px; font-family: inherit;
    }

    /* ç€‘å¸ƒæµ */
    #notes-container { column-count: 3; column-gap: 20px; }
    @media (max-width: 900px) { #notes-container { column-count: 2; } }
    @media (max-width: 600px) { #notes-container { column-count: 1; } }

    /* ç­†è¨˜å¡ç‰‡ */
    .note-card {
      background: var(--card-bg-color); padding: 20px; margin-bottom: 20px;
      border-radius: 12px; border: 1px solid var(--border-color);
      break-inside: avoid; display: inline-block; width: 100%; box-sizing: border-box;
      transition: box-shadow 0.3s, transform 0.3s;
    }
    .note-card:hover {
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      transform: translateY(-4px);
    }
    
    .note-content {
      white-space: pre-wrap;
      overflow-wrap: break-word;
      font-size: 15px;
      line-height: 1.7;
      margin-bottom: 16px;
    }
    .note-content a { color: var(--accent-color); text-decoration: underline; }

    /* Meta å€åŸŸï¼šå…©è¡Œæ’ç‰ˆ */
    .note-meta {
      font-size: 13px;
      color: var(--secondary-text-color);
      border-top: 1px solid var(--border-color);
      padding-top: 12px;
      display: flex;
      flex-direction: column; 
      gap: 12px;
    }

    .note-actions { display: flex; gap: 8px; }
    .note-actions button {
      padding: 6px 12px; font-size: 12px; border-radius: 6px;
      cursor: pointer; color: #fff; border: 1px solid transparent; font-family: inherit;
      transition: all 0.2s;
    }
    .edit-btn, .save-btn { background-color: var(--edit-color); }
    .copy-btn { background-color: var(--copy-color); }
    .delete-btn { background-color: var(--danger-color); }

    /* ç·¨è¼¯æ¨¡å¼ Textarea */
    .edit-textarea {
      width: 100%; min-height: 120px; box-sizing: border-box;
      border: 1px solid var(--accent-color); border-radius: 8px;
      font-family: inherit; font-size: 15px; line-height: 1.7; padding: 8px;
    }
    
    #loader { text-align: center; padding: 20px; color: var(--accent-color); font-weight: bold; }
	
  </style>
</head>
<body>
  <div id="app-container">
    <h1>ğŸ€ é›²ç«¯è¨˜äº‹æœ¬ ğŸ€</h1>
    
    <div class="input-area">
      <textarea id="note-input" placeholder="åœ¨é€™è£¡å¯«ä¸‹æ–°çš„æƒ³æ³•..."></textarea>
      <button id="add-btn">æ–°å¢ç­†è¨˜</button>
    </div>

    <input type="text" id="search-input" placeholder="æœå°‹ç­†è¨˜...">
    
    <div id="loader" style="display:none;">åŒæ­¥ä¸­...</div>
    <div id="notes-container"></div>
  </div>
  <script>
    // â˜… è«‹å¡«å…¥æ‚¨çš„ GAS Web App URL â˜…
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby--Mh49PC5MuylDq7NS60RBWrFnXjXDy0MVeE6m6iRlAxdAL3DFlKpDkvf171flfIM/exec';

    const noteInput = document.getElementById('note-input');
    const addBtn = document.getElementById('add-btn');
    const notesContainer = document.getElementById('notes-container');
    const loader = document.getElementById('loader');
    const searchInput = document.getElementById('search-input');

    let allNotes = JSON.parse(localStorage.getItem('my_notes_cache') || '[]');

    document.addEventListener('DOMContentLoaded', () => {
      renderNotes(); 
      fetchNotesFromServer();
    });

    async function callApi(action, data = {}) {
      const payload = { action, ...data };
      try {
        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        return await response.json();
      } catch (err) {
        console.error('API Error:', err);
        throw err;
      }
    }

    async function fetchNotesFromServer() {
      loader.style.display = 'block';
      try {
        const notes = await callApi('getNotes');
        allNotes = notes;
        localStorage.setItem('my_notes_cache', JSON.stringify(allNotes));
        renderNotes();
      } catch (err) {
        console.log('ä½¿ç”¨å¿«å–å…§å®¹');
      } finally {
        loader.style.display = 'none';
      }
    }

    function linkify(text) {
      const urlPattern = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
      return text.replace(urlPattern, (url) => {
        return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
      });
    }

    function renderNotes() {
      const searchTerm = searchInput.value.toLowerCase();
      notesContainer.innerHTML = '';
      
      const filtered = allNotes
        .filter(n => n.content.toLowerCase().includes(searchTerm))
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      filtered.forEach(note => {
        const card = document.createElement('div');
        card.className = 'note-card';
        card.dataset.id = note.id;
        const dateStr = new Date(note.timestamp).toLocaleString('zh-TW', {
            year: 'numeric', month: '2-digit', day: '2-digit', 
            hour: '2-digit', minute: '2-digit', hour12: false 
        });
        
        const safeContent = escapeHtml(note.content);
        const contentWithLinks = linkify(safeContent);

        card.innerHTML = `
          <div class="note-content">${contentWithLinks}</div>
          <div class="note-meta">
            <span>${dateStr}</span>
            <div class="note-actions">
              <button class="edit-btn">ç·¨è¼¯</button>
              <button class="copy-btn">è¤‡è£½</button>
              <button class="delete-btn">åˆªé™¤</button>
            </div>
          </div>
        `;
        notesContainer.appendChild(card);
      });
    }

    // äº‹ä»¶å§”æ´¾ï¼šçµ±ä¸€è™•ç†å¡ç‰‡æŒ‰éˆ• (å›æ­¸åŸç‰ˆé‚è¼¯)
    notesContainer.addEventListener('click', (e) => {
      const target = e.target;
      const card = target.closest('.note-card');
      if (!card) return;
      const id = card.dataset.id;

      if (target.classList.contains('edit-btn')) {
        switchToEditMode(card, target);
      } else if (target.classList.contains('save-btn')) {
        saveNote(id, card, target);
      } else if (target.classList.contains('copy-btn')) {
        copyNote(card, target);
      } else if (target.classList.contains('delete-btn')) {
        deleteNote(id, card);
      }
    });

    async function addNewNote() {
      const content = noteInput.value.trim();
      if (!content) return alert('ç­†è¨˜å…§å®¹ä¸èƒ½ç‚ºç©ºï¼');
      addBtn.disabled = true;
      addBtn.innerText = 'æ–°å¢ä¸­...';
      try {
        const res = await callApi('addNote', { content });
        if (res.status === 'success') {
          allNotes.unshift(res.note);
          localStorage.setItem('my_notes_cache', JSON.stringify(allNotes));
          noteInput.value = '';
          renderNotes();
        }
      } finally {
        addBtn.disabled = false;
        addBtn.innerText = 'æ–°å¢ç­†è¨˜';
      }
    }

    function switchToEditMode(card, button) {
      const contentDiv = card.querySelector('.note-content');
      // å–å¾—åŸå§‹ç´”æ–‡å­—ï¼ˆä¸å« <a> æ¨™ç±¤ï¼‰
      const note = allNotes.find(n => n.id === card.dataset.id);
      contentDiv.innerHTML = `<textarea class="edit-textarea">${note.content}</textarea>`;
      contentDiv.querySelector('textarea').focus();
      button.textContent = 'å„²å­˜';
      button.classList.replace('edit-btn', 'save-btn');
    }

    async function saveNote(id, card, button) {
      const newContent = card.querySelector('.edit-textarea').value;
      button.disabled = true;
      button.textContent = 'å„²å­˜ä¸­...';

      try {
        await callApi('editNote', { id, content: newContent });
        const note = allNotes.find(n => n.id === id);
        note.content = newContent;
        note.timestamp = new Date().toISOString();
        localStorage.setItem('my_notes_cache', JSON.stringify(allNotes));
        renderNotes(); // é‡æ–°æ¸²æŸ“ä»¥å¥—ç”¨ linkify
      } catch(e) {
        alert('å„²å­˜å¤±æ•—');
        button.disabled = false;
        button.textContent = 'å„²å­˜';
      }
    }

    function copyNote(card, button) {
      const note = allNotes.find(n => n.id === card.dataset.id);
      navigator.clipboard.writeText(note.content).then(() => {
        const originalText = 'è¤‡è£½';
        button.textContent = 'å·²è¤‡è£½!';
        button.style.backgroundColor = '#72824e';
        setTimeout(() => {
          button.textContent = originalText;
          button.style.backgroundColor = '';
        }, 2000);
      });
    }

    async function deleteNote(id, card) {
      if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡ç­†è¨˜å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
        card.style.opacity = '0.5';
        try {
          await callApi('deleteNote', { id });
          allNotes = allNotes.filter(n => n.id !== id);
          localStorage.setItem('my_notes_cache', JSON.stringify(allNotes));
          card.remove();
        } catch(e) {
          alert('åˆªé™¤å¤±æ•—');
          card.style.opacity = '1';
        }
      }
    }

    searchInput.addEventListener('input', renderNotes);
    addBtn.addEventListener('click', addNewNote);

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
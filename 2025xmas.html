<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025è–èª•æ—…è¡Œ</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://rainchord.s3.ap-east-2.amazonaws.com/bell.png">
<style>
    /* ================================================= */
    /* CSS æ¨£å¼ï¼šè–èª•æº«é¦¨å¯æ„›é¢¨ */
    /* ================================================= */

    @font-face {
        font-family: 'JFOpenHuninn';
        src: url('https://ymdd-image-tw.s3.ap-east-2.amazonaws.com/font/jf-openhuninn-2.1.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
    }

    :root {
        --christmas-red: #D93F3C; 
        --christmas-green: #376F43; 
        --cream-white: #FFFBED; 
        --golden-yellow: #FFD700; 
        --dark-text: #4a4a4a; 
        --shadow: 0 10px 30px rgba(217, 63, 60, 0.2); 
        --border-radius: 20px; 
    }

    body {
        font-family: 'JFOpenHuninn', 'å¾®è»Ÿæ­£é»‘é«”', 'Arial', sans-serif;
        margin: 0;
        padding: 0;
        color: var(--dark-text);
        min-height: 100vh;
        background-color: var(--cream-white); 
        background-image: url('https://rainchord.s3.ap-east-2.amazonaws.com/snowflake.jpg');
        background-size: 200px;
        background-repeat: repeat;
        background-attachment: fixed;
        position: relative;
    }

    body::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.75); 
        z-index: -1; 
    }

    .container {
        max-width: 1000px;
        width: 90%;
        margin: 0 auto;
        padding: 15px 0;
    }

    header {
        background-color: rgba(255, 255, 255, 0.95); 
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 10px 0; 
        border-bottom: 5px solid var(--christmas-red);
    }

    h1 {
        color: var(--christmas-green);
        text-align: center;
        margin: 0;
        font-size: 2.5rem;
        font-weight: 800;
        letter-spacing: 2px;
        text-shadow: 1px 1px 0 var(--golden-yellow);
    }
    
/* æ¨™é¡Œèˆ‡é¸æ“‡å™¨ */
.date-selector-container {
    display: flex;
    justify-content: center; 
    align-items: center;    
    padding: 10px 0;
    background-color: #fff;    
    margin-bottom: 0px;
}

/* èª¿æ•´æ¨™ç±¤çš„æ¨£å¼ï¼Œè®“å®ƒèˆ‡é¸å–®å°é½Š */
.date-selector-container label {
    font-size: 1.2em;
    margin-right: 10px; 
    display: inline-flex;
    align-items: center; 
    height: 100%; 
}
    #date-selector {
        min-width: 150px;
        padding: 10px 15px;
        border: 2px solid var(--christmas-red);
        border-radius: 10px;
        background-color: white;
        font-family: 'JFOpenHuninn', sans-serif;
        font-size: 1.1rem;
        color: var(--christmas-green);
        cursor: pointer;
        appearance: none; 
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23376F43'%3E%3Cpath d='M12 16l-6-6h12z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 16px;
    }
    #date-selector:focus {
        border-color: var(--golden-yellow);
        outline: none;
    }


    /* è¡Œç¨‹æ—¥æœŸåˆ†çµ„åˆ—è¡¨ */
    #itinerary-list {
        display: flex;
        flex-direction: column;
        gap: 30px; 
        padding: 20px 0;
    }

    .date-group {
        border-left: 8px solid var(--christmas-red);
        padding-left: 20px;
        position: relative;
        margin-bottom: 20px;
    }
    /* ç‚ºè·³è½‰éŒ¨é»æº–å‚™ */
    .date-group h2 {
        scroll-margin-top: 30px; 
    }

    .date-title {
        color: var(--christmas-green);
        font-size: 2rem;
        font-weight: 700;
        margin-top: 0;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
    }
    .date-title i {
        color: var(--golden-yellow);
        margin-right: 10px;
        font-size: 1.2em;
        animation: twinkle 1s infinite alternate;
    }

    @keyframes twinkle {
      from { transform: scale(1); opacity: 0.8; }
      to { transform: scale(1.1); opacity: 1; }
    }

    .itinerary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 25px; 
    }

    .itinerary-card {
        background: white;
        border-radius: var(--border-radius); 
        padding: 25px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        display: flex; 
        flex-direction: column; 
        position: relative;
        overflow: hidden;
        border: 2px solid var(--christmas-red);
        cursor: pointer; /* å•Ÿç”¨é»æ“Š */
    }
    
    .itinerary-card::before {
        content: 'ğŸ‰';
        position: absolute;
        top: -10px;
        right: -10px;
        background-color: var(--christmas-red);
        color: white;
        padding: 5px 15px;
        border-radius: 0 0 0 15px;
        font-size: 1.2rem;
        z-index: 10;
        transform: rotate(10deg);
        box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }

    .itinerary-card:hover {
        transform: translateY(-5px); 
        box-shadow: 0 12px 30px rgba(217, 63, 60, 0.3); 
        border-color: var(--christmas-green);
    }

    .item-name {
        color: var(--christmas-green);
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 1.5rem;
        font-weight: 700;
        border-bottom: 2px dashed var(--christmas-green);
        padding-bottom: 5px;
    }

    .item-detail {
        font-size: 1.05rem;
        color: var(--dark-text);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
    }
    .item-detail i {
        margin-right: 8px;
        color: var(--christmas-red);
        font-size: 1.2em;
    }

    .map-link-btn {
        background-color: var(--golden-yellow);
        color: var(--dark-text);
        padding: 10px 15px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s ease;
        text-align: center;
        text-decoration: none;
        margin-top: 15px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        max-width: 100%;
    }

    .map-link-btn:hover {
        background-color: var(--christmas-red);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .map-link-btn i {
        margin-right: 8px;
        color: inherit; 
    }

	.remark-box {
		margin-top: 15px;
		padding: 10px;
		border: 2px solid var(--christmas-red);
		border-radius: 10px;
		background-color: rgba(255, 240, 240, 0.8);
		color: var(--christmas-red);
		font-weight: bold;
		font-size: 1rem;
		display: block; /* â­ï¸ ä¿®æ­£ï¼šæ”¹ç‚º block è®“å…§å®¹è‡ªç„¶æ›è¡Œ */
		/* ç§»é™¤ align-items: flex-start; */
	}
	.remark-box i {
		margin-right: 8px;
		font-size: 1.4em;
		/* è®“ i æ¨™ç±¤è®Šæˆè¡Œå…§å€å¡Šï¼Œæ‰èƒ½å’Œå¾Œé¢çš„æ–‡å­—åœ¨åŒä¸€è¡Œï¼Œä½†åˆä¸æœƒè¢« flex å½±éŸ¿ */
		display: inline-block; /* â­ï¸ ä¿®æ­£ï¼šè®“ i å’Œæ–‡å­—åœ¨åŒä¸€è¡Œ */
		flex-shrink: 0;
	}

    @media (max-width: 768px) {
        h1 { font-size: 2rem; }
        .date-title { font-size: 1.7rem; }
        .date-group { border-left-width: 5px; padding-left: 15px; }
        .itinerary-grid { grid-template-columns: 1fr; }
        .itinerary-card { padding: 20px; }
    }
    
    /* ================================================= */
    /* Modal/Popup æ¨£å¼ (ç¶­æŒä¸è®Š) */
    /* ================================================= */
    .modal {
        position: fixed;
        z-index: 200;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5); 
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .modal.open {
        display: flex;
        opacity: 1;
    }

    .modal-content {
        background-color: var(--cream-white);
        margin: 5% auto;
        padding: 40px;
        border-radius: 30px; 
        width: 90%;
        max-width: 700px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        position: relative;
        border: 5px solid var(--christmas-red); 
        overflow-y: auto; 
        max-height: 90vh;
    }

    .modal.open .modal-content {
        animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    
    .close-btn { 
        position: absolute;
        top: 15px;
        right: 25px;
        color: var(--christmas-red);
        font-size: 35px;
        font-weight: bold;
        cursor: pointer; 
        line-height: 1;
        transition: color 0.2s;
    }
    .close-btn:hover, .close-btn:focus { 
        color: var(--christmas-green); 
    }

    .modal-body h2 { 
        color: var(--christmas-green); 
        margin-top: 0; 
        margin-bottom: 20px; 
        font-size: 2.2rem;
        border-bottom: 3px dashed var(--golden-yellow);
        padding-bottom: 10px;
    }
    
    .modal-detail-item {
        margin-bottom: 15px;
        padding: 8px 0;
        font-size: 1.1rem;
        color: var(--dark-text);
        display: flex;
        align-items: flex-start;
    }
    .modal-detail-item strong {
        color: var(--christmas-red);
        font-weight: bold;
        min-width: 80px;
        margin-right: 10px;
        flex-shrink: 0;
    }
    .modal-detail-item i {
        margin-right: 8px;
        font-size: 1.2em;
        color: var(--christmas-red);
    }
    
    .modal-link-btn {
        background-color: var(--golden-yellow);
        color: var(--dark-text);
        padding: 12px 20px;
        border-radius: 12px;
        text-decoration: none;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        margin-top: 15px;
        transition: background-color 0.2s;
    }
    .modal-link-btn:hover {
        background-color: var(--christmas-red);
        color: white;
    }
    
    @media (max-width: 768px) {
        .modal-content {
            padding: 30px 20px;
        }
        .modal-body h2 {
            font-size: 1.8rem;
        }
        .modal-detail-item strong {
            min-width: 60px;
        }
    }
    
    /* â­ï¸ æµ®å‹•æŒ‰éˆ•ç¾¤çµ„æ¨£å¼ */
    /* è¨˜å¸³æŒ‰éˆ•èˆ‡å›åˆ°æœ€é ‚æŒ‰éˆ•çš„é€šç”¨æ¨£å¼ */
    #account-fab, #back-to-top {
        position: fixed;
        bottom: 20px;
        right: 20px; /* å…ˆçµ¦ä¸€å€‹é€šç”¨ä½ç½® */
        background-color: var(--golden-yellow);
        color: var(--dark-text);
        border: 3px solid var(--christmas-red);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.2s, transform 0.2s;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        z-index: 100; /* ç¢ºä¿åœ¨å…¶ä»–å…§å®¹ä¹‹ä¸Š */
        text-decoration: none; /* ç§»é™¤é€£çµçš„åº•ç·š */
    }

    /* å›åˆ°æœ€é ‚æŒ‰éˆ•çš„ç‰¹å®šä½ç½®èˆ‡é¡¯ç¤ºé‚è¼¯ */
    #back-to-top {
        right: 20px; /* å³å´ç¬¬ä¸€å€‹ */
        opacity: 0;
        visibility: hidden;
    }
    #back-to-top.show {
        opacity: 1;
        visibility: visible;
    }
    #back-to-top:hover {
        background-color: var(--christmas-red);
        color: white;
        transform: scale(1.05);
    }
    
    /* è¨˜å¸³æŒ‰éˆ•çš„ç‰¹å®šä½ç½® (èˆ‡å›åˆ°æœ€é ‚æŒ‰éˆ•éŒ¯é–‹) */
    #account-fab {
        right: 80px; /* è·é›¢å³å´ 80pxï¼Œç•™å‡º 20px é–“éš” + 50px æŒ‰éˆ•å¯¬åº¦ */
        background-color: var(--christmas-green); /* ä½¿ç”¨ç¶ è‰²çªå‡º */
        color: white;
        border-color: var(--golden-yellow); /* é‚Šæ¡†ä½¿ç”¨é‡‘è‰² */
    }

    #account-fab:hover {
        background-color: #275631; /* ç¶ è‰²è®Šæ·± */
        color: var(--golden-yellow);
        transform: scale(1.05);
    }

    @media (max-width: 768px) {
        /* åœ¨æ‰‹æ©Ÿä¸Šï¼Œå°‡è¨˜å¸³æŒ‰éˆ•æ”¾åˆ°å·¦å´ï¼Œå›åˆ°æœ€é ‚æŒ‰éˆ•æ”¾åˆ°å³å´ï¼Œé¿å…æ“æ“  */
        #account-fab {
            left: 20px;
            right: auto;
        }
        #back-to-top {
            right: 20px;
        }
    }
</style>
</head>
<body>

    <header>
        <div class="container">
            <h1 id="page-title"><i class="ri-tree-line"></i> 2025è–èª•æ—…è¡Œ <i class="ri-gift-line"></i></h1>
            <div class="date-selector-container">
                <label for="date-selector">ä»Šå¤©æ˜¯ï¼š</label>
                <select id="date-selector" onchange="scrollToDate(this.value)">
                    <option value="">é¸æ“‡æ—¥æœŸ...</option>
                </select>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="status-message">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>
        <div id="itinerary-list">
        </div>
    </div>

    <div id="itineraryModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div class="modal-body">
                <h2 id="modal-title"></h2>
                <div id="modal-details"></div>
                <div id="modal-links"></div>
            </div>
        </div>
    </div>
    
    <a id="account-fab" href="https://script.google.com/macros/s/AKfycbx33GmevnRQDs43jafdv5MMe7hkBO5UXfEN8SpAhM1UDYuWhvmjKa-j11_5hj22iq_DAQ/exec" target="_blank" title="å‰å¾€è¨˜å¸³">
        <i class="ri-money-cny-box-line"></i>
    </a>
    
    <div id="back-to-top" onclick="backToTop()" title="å›åˆ°æœ€é ‚">
        <i class="ri-arrow-up-line"></i>
    </div>
    
    <p style="text-align:center; padding-top: 30px; color: #aaa;">Made in â¤ï¸ by Ivy</p>

<script>
// =================================================
// JavaScript é‚è¼¯ï¼šè¡Œç¨‹è¡¨åŠŸèƒ½ (å·²ä¿®å¾©æ›è¡Œç¬¦è™Ÿå•é¡Œ & æ–°å¢å‚™è¨»é€£çµè§£æ)
// =================================================

// âš ï¸ è«‹ç¢ºä¿æ‚¨çš„ Apps Script éƒ¨ç½²ç¶²å€æ˜¯æ­£ç¢ºçš„ï¼
// æ‚¨å¯ä»¥æ›¿æ›ç‚ºæ‚¨çš„ Web App URL
const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbw4mje3Mq7p1U0DHF7PtxG17Yq4fAkMAgoZTQBUMKR3dlC4slFGYLdjFoHNMeKHXWzhGg/exec';
const itineraryList = document.getElementById('itinerary-list');
const statusMessage = document.getElementById('status-message');
const modal = document.getElementById('itineraryModal');
const closeBtn = document.querySelector('#itineraryModal .close-btn');
const backToTopBtn = document.getElementById('back-to-top');

let allItineraryItems = [];
let fieldMap = {}; 
let hiddenFields = []; 
let groupedItinerary = {}; 

// é—œé–‰ Modal äº‹ä»¶ç›£è½
closeBtn.onclick = () => { modal.classList.remove('open'); };
window.onclick = (event) => {
    if (event.target == modal) {
        modal.classList.remove('open');
    }
};

// æ»¾å‹•äº‹ä»¶ç›£è½å™¨ï¼Œæ§åˆ¶å›åˆ°æœ€é ‚æŒ‰éˆ•çš„é¡¯ç¤º
window.onscroll = function() {
    if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
        backToTopBtn.classList.add('show');
    } else {
        backToTopBtn.classList.remove('show');
    }
};

/**
 * è¼”åŠ©å‡½å¼ï¼šå®‰å…¨åœ°è§£æç´”æ—¥æœŸå­—ä¸² (ä¾‹å¦‚ YYYY/MM/DD) ç‚º Date ç‰©ä»¶
 * @param {string} dateString - YYYY/MM/DD æˆ– YYYY-MM-DD
 * @returns {Date|null} æœ¬åœ°æ—¥æœŸç‰©ä»¶
 */
function parseLocalDay(dateString) {
    if (!dateString) return null;
    // å…è¨± YYYY/MM/DD æˆ– YYYY-MM-DD æ ¼å¼
    const parts = dateString.match(/(\d{4})[/-](\d{1,2})[/-](\d{1,2})/); 
    if (parts) {
        // ä½¿ç”¨ yyyy, mm-1, dd æ§‹é€  Date ç‰©ä»¶ï¼Œå®ƒæœƒå°‡æ™‚é–“è¨­ç½®ç‚ºç•¶åœ°çš„ 00:00:00
        const year = parseInt(parts[1], 10);
        const month = parseInt(parts[2], 10) - 1; // æœˆä»½æ˜¯ 0-based
        const day = parseInt(parts[3], 10);
        return new Date(year, month, day);
    }
    return null;
}

/**
 * è¼”åŠ©å‡½å¼ï¼šå°‡ Date ç‰©ä»¶æ ¼å¼åŒ–ç‚º YYYY/MM/DD æ ¼å¼çš„å­—ä¸² (ç”¨æ–¼é¡¯ç¤ºå’Œ Key)
 * @param {Date} date - Date ç‰©ä»¶
 * @returns {string} YYYY/MM/DD
 */
function formatKeyDate(date) {
    if (date.toString() === 'Invalid Date') return '';
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}/${month}/${day}`;
}


// =================================================
// â­ï¸ æ–°å¢åŠŸèƒ½ï¼šé€£çµè½‰æ›è¼”åŠ©å‡½å¼
// =================================================

/**
 * å°‡æ–‡å­—ä¸­çš„ URL (http/https é–‹é ­) è½‰æ›ç‚º <a href="...">...</a> è¶…é€£çµã€‚
 * @param {string} text - åŒ…å«æ½›åœ¨é€£çµçš„æ–‡å­—ã€‚
 * @returns {string} åŒ…å« HTML è¶…é€£çµæ¨™ç±¤çš„æ–‡å­—ã€‚
 */
function linkifyText(text) {
    if (!text) return '';
    
    // åŒ¹é… http:// æˆ– https:// é–‹é ­çš„ URLã€‚
    // é€™å€‹æ­£å‰‡è¡¨é”å¼è¶³å¤ å®‰å…¨ï¼Œä¸¦ä¸”å¯ä»¥è™•ç†å¤§éƒ¨åˆ†æƒ…æ³ã€‚
    const urlPattern = /(\b(https?):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
    
    // ä½¿ç”¨ replace æ–¹æ³•å°‡åŒ¹é…åˆ°çš„ URL æ›¿æ›æˆå®Œæ•´çš„ <a> æ¨™ç±¤
    return text.replace(urlPattern, function(url) {
        // ç¢ºä¿é€£çµåœ¨æ–°è¦–çª—é–‹å•Ÿï¼Œä¸¦è¨­ç½® rel="noopener noreferrer" æé«˜å®‰å…¨æ€§
        return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
    });
}


/**
 * 1. æŠ“å– Google Apps Script æä¾›çš„ JSON è³‡æ–™ (å¢å¼·è¨ºæ–·å’ŒéŒ¯èª¤è™•ç†)
 */
async function fetchItineraryData() {
    statusMessage.style.display = 'block';
    statusMessage.classList.remove('error');
    statusMessage.textContent = 'æ­£åœ¨å‘¼å«è–èª•è€å…¬å…¬çš„è¡Œç¨‹è¡¨ï¼Œè«‹ç¨å€™...';
    
    try {
        const response = await fetch(GAS_API_URL);
        
        // ç¢ºä¿ HTTP ç‹€æ…‹ç¢¼æ˜¯ OK (200-299)
        if (!response.ok) {
             statusMessage.classList.add('error');
             statusMessage.innerHTML = `<p><strong>ğŸš¨ ç¶²è·¯è«‹æ±‚å¤±æ•—ï¼</strong> ç‹€æ…‹ç¢¼: ${response.status}</p>
             <p>è«‹æª¢æŸ¥æ‚¨çš„ GAS_API_URL æ˜¯å¦æ­£ç¢ºï¼Œä¸¦ç¢ºèª Apps Script éƒ¨ç½²ç‰ˆæœ¬ã€‚</p>`;
             return;
        }

        const result = await response.json();
        
        // å¦‚æœ Apps Script æˆåŠŸå›å‚³ï¼Œä½†å›å‚³çš„ JSON è£¡æœ‰éŒ¯èª¤æ——æ¨™ (é€™æ˜¯ GS ç¨‹å¼ç¢¼çš„è¨­è¨ˆ)
        if (result.success === false) {
             statusMessage.classList.add('error');
             statusMessage.innerHTML = `
                <p><strong>ğŸš¨ Apps Script ç™¼ç”Ÿç¨‹å¼éŒ¯èª¤ï¼</strong></p>
                <p>è«‹æª¢æŸ¥ Apps Script ç·¨è¼¯å™¨ä¸­çš„ã€Œè¨˜éŒ„ã€ã€‚</p>
                <p><strong>éŒ¯èª¤è©³æƒ… (ä¾†è‡ª GS):</strong></p>
                <pre>${result.detail || result.error || 'æœªçŸ¥çš„ Apps Script éŒ¯èª¤ã€‚'}</pre>
             `;
             return;
        }

        if (!result.data || !Array.isArray(result.data)) {
            // æª¢æŸ¥è³‡æ–™æ˜¯å¦ç‚ºç©ºæˆ–æ ¼å¼éŒ¯èª¤
            statusMessage.classList.add('error');
            statusMessage.innerHTML = `<p><strong>ğŸš¨ è³‡æ–™çµæ§‹éŒ¯èª¤ï¼</strong> API å›å‚³çš„è³‡æ–™ (data æ¬„ä½) ä¸æ˜¯é™£åˆ—æˆ–ç‚ºç©ºã€‚</p>
            <p><strong>Settings:</strong> ${JSON.stringify(result.settings)}</p>`;
            return;
        }
        
        // --- æˆåŠŸæŠ“å–èˆ‡è™•ç† ---
        fieldMap = result.settings.fieldMap || {};
        hiddenFields = result.settings.hiddenFields || [];
        allItineraryItems = result.data;
        
        if (allItineraryItems.length === 0) {
            statusMessage.textContent = 'æˆåŠŸé€£æ¥ï¼Œä½†è©¦ç®—è¡¨ä¸­æ²’æœ‰æœ‰æ•ˆçš„è¡Œç¨‹è³‡æ–™ã€‚è«‹ç¢ºèªæ‚¨çš„ã€Œè¡Œç¨‹è¦åŠƒã€å·¥ä½œè¡¨ã€‚';
            return;
        }

        // éš±è—ç‹€æ…‹è¨Šæ¯ï¼Œè¡¨ç¤ºæˆåŠŸ
        statusMessage.style.display = 'none';
        
        // è™•ç†æ—¥æœŸåˆ†çµ„
        groupedItinerary = processItineraryData(allItineraryItems, fieldMap);
        
        // æª¢æŸ¥æ—¥æœŸè§£ææ˜¯å¦æˆåŠŸ
        if (Object.keys(groupedItinerary).length === 0) {
             statusMessage.style.display = 'block';
             statusMessage.classList.add('error');
             statusMessage.innerHTML = `<p><strong>ğŸš¨ æ—¥æœŸè§£æå¤±æ•—ï¼</strong></p>
             <p>é›–ç„¶æŠ“åˆ° ${allItineraryItems.length} ç­†è³‡æ–™ï¼Œä½†ç„¡æ³•å¾ã€Œ${fieldMap.START_DATE || 'æœªè¨­å®š'}ã€æ¬„ä½è§£æå‡ºæœ‰æ•ˆæ—¥æœŸã€‚</p>
             <p>è«‹ç¢ºèªè©¦ç®—è¡¨ä¸­æ—¥æœŸæ¬„ä½çš„æ ¼å¼ç‚º <code>YYYY/MM/DD</code> æˆ– <code>YYYY-MM-DD</code>ã€‚</p>`;
             return;
        }

        renderItinerary(groupedItinerary);
        
        // æ¸²æŸ“æ—¥æœŸé¸å–®
        const sortedDates = Object.keys(groupedItinerary).sort();
        const dateSelectorContainer = document.querySelector('.date-selector-container');
        if (sortedDates.length > 1) {
             renderDateSelector(sortedDates);
             dateSelectorContainer.style.display = 'flex'; // é¡¯ç¤ºé¸å–®
        } else {
             dateSelectorContainer.style.display = 'none'; // éš±è—é¸å–®
        }

    } catch (error) {
        console.error('æŠ“å–è³‡æ–™å¤±æ•—:', error);
        statusMessage.classList.add('error');
        // æ•æ‰ç¶²è·¯æˆ– JSON è§£æå¤±æ•—
        statusMessage.innerHTML = `<p><strong>è‡´å‘½éŒ¯èª¤ï¼š</strong>ç€è¦½å™¨ç«¯ç„¡æ³•é€£æ¥æˆ–è§£æ JSONã€‚</p>
        <p>è«‹æª¢æŸ¥ <code>GAS_API_URL</code> æ˜¯å¦æ­£ç¢ºï¼Œä¸¦ç¢ºèª Apps Script éƒ¨ç½²ç‚ºã€Œä»»ä½•äººã€ã€‚</p>
        <p><strong>è©³æƒ…:</strong> ${error.message}</p>`;
    }
}


/**
 * 2. è™•ç†è¡Œç¨‹è³‡æ–™ï¼Œå°‡æ—¥æœŸç¯„åœå±•é–‹ä¸¦æŒ‰æ—¥æœŸåˆ†çµ„ (ä¿®æ­£æ—¥æœŸè§£æ)
 */
function processItineraryData(items, keys) {
    const groupedByDate = {}; 

    items.forEach(item => {
        // ç¢ºä¿ startDateStr å’Œ endDateStr å·²ç¶“æ˜¯ Apps Script å‚³ä¾†çš„ç´”å­—ä¸²
        const startDateStr = item[keys.START_DATE] || '';
        const endDateStr = item[keys.END_DATE] || startDateStr; 
        
        if (!startDateStr) return; 

        // ä½¿ç”¨æ–°çš„ parseLocalDay å‡½å¼å®‰å…¨åœ°å‰µå»º Date ç‰©ä»¶
        const startDate = parseLocalDay(startDateStr);
        const endDate = parseLocalDay(endDateStr);
        
        if (!startDate || !endDate || startDate > endDate) {
             console.warn('æ—¥æœŸç¯„åœéŒ¯èª¤æˆ–æ ¼å¼ä¸æ­£ç¢ºï¼Œè·³é:', item, startDateStr, endDateStr);
             return;
        }

        let currentDate = startDate;
        
        // è¿´åœˆéæ­·æ—¥æœŸç¯„åœ
        while (currentDate <= endDate) {
            // ä½¿ç”¨ formatKeyDate ç¢ºä¿æ—¥æœŸéµçš„æ ¼å¼ä¸€è‡´æ€§ (YYYY/MM/DD)
            const dateKey = formatKeyDate(currentDate); 
            
            if (!groupedByDate[dateKey]) {
                groupedByDate[dateKey] = [];
            }
            
            // å°‡è¡Œç¨‹é …ç›®æ·»åŠ åˆ°ç•¶å¤©
            groupedByDate[dateKey].push(item);

            // æ¨é€²åˆ°ä¸‹ä¸€å¤© (ç¢ºä¿ä¸æœƒç”¢ç”Ÿæ™‚å€å•é¡Œ)
            const nextDay = new Date(currentDate);
            nextDay.setDate(currentDate.getDate() + 1);
            currentDate = nextDay;
        }
    });
    return groupedByDate;
}

/**
 * 3. æ¸²æŸ“æ—¥æœŸé¸å–® (ä½¿ç”¨ YYYY/MM/DD æ ¼å¼ä½œç‚º Value)
 * @param {Array<string>} sortedDates - æ’åºå¾Œçš„æ—¥æœŸåˆ—è¡¨ (YYYY/MM/DD æ ¼å¼)
 */
function renderDateSelector(sortedDates) {
    const selector = document.getElementById('date-selector');
    selector.innerHTML = '<option value="">é¸æ“‡æ—¥æœŸ...</option>'; 
    
    sortedDates.forEach(date => {
        const option = document.createElement('option');
        option.value = date; // value ä½¿ç”¨ YYYY/MM/DD 
        option.textContent = date;
        selector.appendChild(option);
    });
}

/**
 * 4. æ»¾å‹•åˆ°æŒ‡å®šæ—¥æœŸ
 * @param {string} dateKey - è¦è·³è½‰çš„æ—¥æœŸ (YYYY/MM/DD)
 */
function scrollToDate(dateKey) {
    if (!dateKey) return;
    // æ‰¾åˆ°å°æ‡‰çš„æ—¥æœŸæ¨™é¡Œ h2 å…ƒç´  (ID ä¸­ / è¢«æ›¿æ›ç‚º -)
    const targetElement = document.getElementById(`date-${dateKey.replace(/\//g, '-')}`); 
    if (targetElement) {
        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

/**
 * 5. æ¸²æŸ“è¡Œç¨‹åˆ—è¡¨ (å·²ç§»é™¤æ™‚é–“æ’åºï¼Œæ”¹ä¾è³´è©¦ç®—è¡¨åŸå§‹é †åº)
 */
function renderItinerary(groupedData) {
    itineraryList.innerHTML = '';
    
    // ç¢ºä¿æ—¥æœŸéµçš„æ ¼å¼ç‚º YYYY/MM/DD ä¸¦æ’åº (æ—¥æœŸæ’åºä¿ç•™ï¼Œå› ç‚ºé€™æ˜¯åˆ†çµ„ä¾æ“š)
    const sortedDates = Object.keys(groupedData).sort();

    sortedDates.forEach(dateKey => {
        const items = groupedData[dateKey];
        if (items.length === 0) return;

        const dateGroup = document.createElement('div');
        dateGroup.className = 'date-group';

        const title = document.createElement('h2');
        title.className = 'date-title';
        // è¨­ç½® ID æ™‚å°‡ / æ›¿æ›ç‚º -ï¼Œç¢ºä¿ ID æœ‰æ•ˆ
        title.id = `date-${dateKey.replace(/\//g, '-')}`; 
        title.innerHTML = `<i class="ri-star-fill"></i> ${dateKey}`;
        dateGroup.appendChild(title);

        const grid = document.createElement('div');
        grid.className = 'itinerary-grid';

        // é€™è£¡ä¸å†é€²è¡Œæ™‚é–“æ’åºï¼Œç›´æ¥ä½¿ç”¨ items çš„åŸå§‹é †åº (å³è©¦ç®—è¡¨è¡Œé †åº)

        items.forEach((item) => {
            const card = createItineraryCard(item);
            grid.appendChild(card);
        });

        dateGroup.appendChild(grid);
        itineraryList.appendChild(dateGroup);
    });
}

/**
 * 6. å»ºç«‹å–®å€‹è¡Œç¨‹å¡ç‰‡çš„ HTML çµæ§‹
 */
function createItineraryCard(item) {
    const card = document.createElement('div');
    card.className = 'itinerary-card';
    
    // â­ï¸ é—œéµä¿®å¾©ï¼šä½¿ç”¨ JSON.stringify å’Œ replace ä¾†å®‰å…¨åœ°å‚³éç‰©ä»¶è³‡æ–™
    const itemJsonString = JSON.stringify(item).replace(/'/g, "\\'"); 
    card.setAttribute('onclick', `showItineraryModal(${itemJsonString})`);

    const isHidden = (key) => hiddenFields.includes(fieldMap[key]);

    // 1. åç¨±
    const name = document.createElement('h3');
    name.className = 'item-name';
    name.textContent = item[fieldMap.NAME] || 'æœªå‘½åè¡Œç¨‹';
    card.appendChild(name);

    // 2. æ™‚é–“
    const timeValue = item[fieldMap.TIME];
    if (timeValue && timeValue.trim() !== '' && !isHidden('TIME')) {
        const timeDetail = document.createElement('p');
        timeDetail.className = 'item-detail';
        timeDetail.innerHTML = `<i class="ri-time-line"></i> ${timeValue}`;
        card.appendChild(timeDetail);
    }
    
    // 3. æ™¯é»åç¨± 
    const locationNameValue = item[fieldMap.LOCATION_NAME];
    if (locationNameValue && locationNameValue.trim() !== '' && !isHidden('LOCATION_NAME')) {
        const locationDetail = document.createElement('p');
        locationDetail.className = 'item-detail';
        locationDetail.innerHTML = `<i class="ri-map-pin-line"></i> æ™¯é»ï¼š${locationNameValue}`;
        card.appendChild(locationDetail);
    }

// ...
// 4. å‚™è¨» (åªé¡¯ç¤ºå‰ 50 å­—)
const remarkValue = item[fieldMap.REMARK];
if (remarkValue && remarkValue.trim() !== '' && !isHidden('REMARK')) {
    
    // â­ï¸ ä¿®æ­£ï¼šç§»é™¤ .replace(/\n/g, ' ')ã€‚
    // 1. è™•ç†æ›è¡Œï¼šå°‡ \n è½‰æ›ç‚º <br>
    let snippetWithBreaks = remarkValue.replace(/\n/g, '<br>');
    
    // 2. è™•ç†è¶…é€£çµ
    let snippetWithLinks = linkifyText(snippetWithBreaks);
    
    // 3. è™•ç†æˆªæ–· (æ³¨æ„ï¼šæ­¤æ™‚å¯èƒ½åœ¨ <br> æˆ– <a> æ¨™ç±¤ä¸­é–“æˆªæ–·ï¼Œä½†ç‚ºäº†é¡¯ç¤ºå¤šè¡Œï¼Œé€™æ˜¯å¿…è¦çš„å–æ¨)
    // ç‚ºäº†ä¿è­‰æ¨™ç±¤ä¸æœƒè¢«æˆªæ–·ï¼Œæˆ‘å€‘åªå°ç´”æ–‡å­—é€²è¡Œæˆªæ–·ï¼Œä½†åœ¨é€™è£¡æˆ‘å€‘ä¸»è¦ç›®çš„æ˜¯ç¢ºä¿æ›è¡Œå’Œé€£çµï¼Œ
    // æ‰€ä»¥æˆ‘å€‘åªæˆªæ–·æ–‡æœ¬çš„é•·åº¦ï¼Œä¸¦å‡è¨­ç´”æ–‡å­—å…§å®¹ä¸æœƒå¤ªé•·ã€‚
    // é€™è£¡æˆ‘å€‘åªæˆªå–å‰ 50 å€‹å­—å…ƒçš„åŸå§‹æ–‡å­—ï¼Œç„¶å¾Œå†é€²è¡Œ HTML è™•ç†
    const rawSnippet = remarkValue.length > 50 ? remarkValue.substring(0, 50) + '...' : remarkValue;
    
    // æœ€çµ‚é¡¯ç¤ºçš„å…§å®¹ï¼Œéœ€è¦åŒ…å« <br> å’Œ <a> æ¨™ç±¤
    const finalDisplayHtml = linkifyText(rawSnippet).replace(/\n/g, '<br>');
    
    const remarkBox = document.createElement('div');
    remarkBox.className = 'remark-box';
    // ä½¿ç”¨ innerHTML ä¾†æ¸²æŸ“æ›è¡Œå’Œè¶…é€£çµ
    remarkBox.innerHTML = `<i class="ri-error-warning-line"></i> å‚™è¨»ï¼š${finalDisplayHtml}`;
    card.appendChild(remarkBox);
}

    return card;
}

/**
 * 7. é¡¯ç¤ºè¡Œç¨‹è©³ç´°è³‡è¨Šçš„ Modal
 */
function showItineraryModal(item) {
    try {
        document.getElementById('modal-title').textContent = item[fieldMap.NAME] || 'è¡Œç¨‹è©³æƒ…';
        
        const detailsContainer = document.getElementById('modal-details');
        const linksContainer = document.getElementById('modal-links');
        detailsContainer.innerHTML = ''; 
        linksContainer.innerHTML = '';

        const detailItems = [
            { key: 'START_DATE', label: 'é–‹å§‹æ—¥æœŸ', icon: 'ri-calendar-line' },
            { key: 'END_DATE', label: 'çµæŸæ—¥æœŸ', icon: 'ri-calendar-check-line' },
            { key: 'TIME', label: 'æ™‚é–“', icon: 'ri-time-line' },
            { key: 'LOCATION_NAME', label: 'æ™¯é»åç¨±', icon: 'ri-map-pin-line' },
            { key: 'REMARK', label: 'å®Œæ•´å‚™è¨»', icon: 'ri-chat-1-line' },
        ];
        
        // æ¸²æŸ“è©³ç´°è³‡è¨Š
        detailItems.forEach(({ key, label, icon }) => {
            const fieldHeader = fieldMap[key];
            const value = item[fieldHeader]; 

            if (fieldHeader && value && value.trim() !== '' && !hiddenFields.includes(fieldHeader)) {
                const detailItem = document.createElement('div');
                detailItem.className = 'modal-detail-item';
                
                let displayValue = value;
                
                // è™•ç†å‚™è¨»æ¬„ä½ï¼š
                if (key === 'REMARK') {
                    // 1. å°‡ç´”æ–‡å­—é€£çµè½‰æ›ç‚ºå¯é»æ“Šçš„è¶…é€£çµ
                    displayValue = linkifyText(displayValue); 
                    // 2. å°‡æ›è¡Œç¬¦è™Ÿ (\n) æ›¿æ›ç‚º HTML çš„æ›è¡Œæ¨™ç±¤ <br>
                    displayValue = displayValue.replace(/\n/g, '<br>'); 
                } else {
                    // éå‚™è¨»æ¬„ä½ï¼Œåªéœ€è¦è™•ç†æ›è¡Œ
                    displayValue = displayValue.replace(/\n/g, '<br>');
                }

                detailItem.innerHTML = `
                    <i class="${icon}"></i>
                    <strong>${label}:</strong> 
                    <span>${displayValue}</span>
                `;
                // ç‚ºäº†è®“å‚™è¨»ä¸­çš„è¶…é€£çµèƒ½å¤ è¢«æ¸²æŸ“ï¼Œé€™è£¡å¿…é ˆä½¿ç”¨ innerHTML
                detailsContainer.appendChild(detailItem);
            }
        });
        
        // æ¸²æŸ“åœ°åœ–é€£çµæŒ‰éˆ•
        const mapLinkValue = item[fieldMap.MAP_LINK];
        const mapLinkHeader = fieldMap.MAP_LINK;

        if (mapLinkValue && mapLinkValue.trim() !== '' && !hiddenFields.includes(mapLinkHeader)) {
            const mapLinkBtn = document.createElement('a');
            mapLinkBtn.href = mapLinkValue;
            mapLinkBtn.target = '_blank';
            mapLinkBtn.className = 'modal-link-btn';
            mapLinkBtn.innerHTML = '<i class="ri-pin-distance-line"></i> å°èˆªå»æ™¯é»';
            linksContainer.appendChild(mapLinkBtn);
        }
        
        modal.classList.add('open');

    } catch (error) {
        console.error('é¡¯ç¤ºè¡Œç¨‹è³‡æ–™å¤±æ•—:', error);
        alert('ç„¡æ³•é¡¯ç¤ºè©³ç´°è³‡è¨Šï¼Œè«‹æª¢æŸ¥ Apps Script çš„è³‡æ–™è¼¸å‡ºæˆ–æ¬„ä½å°æ‡‰ã€‚');
    }
}

/**
 * 8. å›åˆ°é é¢é ‚éƒ¨
 */
function backToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
}


// é é¢è¼‰å…¥å®Œæˆå¾Œï¼Œé–‹å§‹æŠ“å–è³‡æ–™
document.addEventListener('DOMContentLoaded', fetchItineraryData);
</script>
</body>
</html>
